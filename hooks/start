#!/usr/bin/env bash
set -xo pipefail nounset

if [[ "${TRACE-0}" == "1" ]]; then
    set -o xtrace
fi
cd "$(dirname "$0")"

notify-send "$(pomodoro status --format "🍅 %c started")" "$(pomodoro status --format "%d")"

playerctl -p cmus,%any play
if test "$(playerctl -p cmus,%any status)" != "Playing"; then
    notify-send "🍅 ⚠️" "Couldn’t start playing anything"
fi
playerctl -p cmus,%any loop Playlist

# Wait for the notifications to be sent before going in DND mode
sleep 2
if test -f ~/.bin/dnd_toggle && test -x ~/.bin/dnd_toggle ; then
    ~/.bin/dnd_toggle on
else
    ps -C mako >/dev/null
    if [[ $? -eq 0 ]]; then
        makoctl set-mode do-not-disturb
    fi
    dunst_pid=$(pgrep dunst)
    if [[ $? -eq 0 ]]; then
        kill -SIGUSR1 "$dunst_pid"
    fi
fi
